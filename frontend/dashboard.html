<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema O.S</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="navbar-brand">
                    üîß Sistema O.S
                </div>
                <div class="navbar-links">
                    <a href="dashboard.html" class="navbar-link active">Dashboard</a>
                    <a href="os-list.html" class="navbar-link">Ordens de Servi√ßo</a>
                    <a href="users.html" class="navbar-link hidden" id="nav-users">Gerenciar Equipe</a>
                    <span class="navbar-link" style="color: var(--text-primary);" id="user-name"></span>
                    <button class="btn btn-sm btn-secondary" id="logout-btn">Sair</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 2rem 1rem;">
        <h1 class="mb-4">Dashboard</h1>

        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <div id="dashboard-content" class="hidden">
            <!-- Stats Cards -->
            <div class="grid grid-4 mb-4">
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Aguardando</div>
                    <h2 style="color: var(--warning); margin-bottom: 0;" id="stat-aguardando">0</h2>
                </div>
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Em Andamento</div>
                    <h2 style="color: var(--warning); margin-bottom: 0;" id="stat-em-andamento">0</h2>
                </div>
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Conclu√≠do</div>
                    <h2 style="color: var(--success); margin-bottom: 0;" id="stat-concluido">0</h2>
                </div>
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Total</div>
                    <h2 style="margin-bottom: 0;" id="stat-total">0</h2>
                </div>
            </div>

            <!-- Motivo Stats -->
            <div class="grid grid-3 mb-4">
                <div class="card" style="border-left: 4px solid var(--danger);">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üì° Caixa sem sinal</div>
                    <h2 style="margin-bottom: 0;" id="stat-sem-sinal">0</h2>
                </div>
                <div class="card" style="border-left: 4px solid var(--warning);">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üìà Sinal Alto</div>
                    <h2 style="margin-bottom: 0;" id="stat-sinal-alto">0</h2>
                </div>
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üöÄ Amplia√ß√£o de
                        atendimento</div>
                    <h2 style="margin-bottom: 0;" id="stat-ampliacao">0</h2>
                </div>
            </div>

            <!-- Metrics Cards -->
            <div class="grid grid-3 mb-4">
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">‚è±Ô∏è Tempo M√©dio de Espera
                    </div>
                    <h3 style="margin-bottom: 0;" id="metric-espera">-</h3>
                </div>
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">‚ö° Tempo M√©dio de Execu√ß√£o
                    </div>
                    <h3 style="margin-bottom: 0;" id="metric-execucao">-</h3>
                </div>
                <div class="card">
                    <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üìä Tempo Total M√©dio
                    </div>
                    <h3 style="margin-bottom: 0;" id="metric-total">-</h3>
                </div>
            </div>

            <!-- Technicians Stats -->
            <div class="card mb-4">
                <h3 class="mb-3">üìà Estat√≠sticas por T√©cnico</h3>
                <div id="tecnico-stats-container"></div>
            </div>

            <!-- Cities Stats -->
            <div class="card mb-4">
                <h3 class="mb-3">üèòÔ∏è Ordens por Cidade</h3>
                <div id="cidade-stats-container"></div>
            </div>

            <!-- Rompimento e Manuten√ß√µes Section -->
            <div class="card mb-4">
                <h3 class="mb-3">üîß Rompimento e Manuten√ß√µes</h3>
                
                <!-- Stats Cards -->
                <div class="grid grid-4 mb-3">
                    <div class="card" style="border-left: 4px solid var(--danger);">
                        <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üîß Rompimento Aguardando</div>
                        <h2 style="margin-bottom: 0;" id="stat-rompimento-aguardando">0</h2>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--warning);">
                        <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">üîß Rompimento Em Andamento</div>
                        <h2 style="margin-bottom: 0;" id="stat-rompimento-andamento">0</h2>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--primary);">
                        <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">‚öôÔ∏è Manuten√ß√£o Aguardando</div>
                        <h2 style="margin-bottom: 0;" id="stat-manutencao-aguardando">0</h2>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--info);">
                        <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">‚öôÔ∏è Manuten√ß√£o Em Andamento</div>
                        <h2 style="margin-bottom: 0;" id="stat-manutencao-andamento">0</h2>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N√∫mero O.S</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Cidade</th>
                                <th>Prazo</th>
                                <th>Tempo Restante</th>
                                <th>Porta Placa/OLT</th>
                                <th>T√©cnico Campo</th>
                                <th>T√©cnico Executor</th>
                                <th>PPPOE</th>
                                <th>Criado Em</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="rompimento-manutencao-tbody">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="text-center mt-5 mb-4">
            <p class="text-muted" style="font-size: 0.85rem;">
                Criado e desenvolvido por Anderson Tadeu Alves
            </p>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Auth guard
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        // Display user name
        const user = api.getUser();
        document.getElementById('user-name').textContent = user.nome || user.username;

        // Show team management if admin
        if (user.role === 'admin') {
            document.getElementById('nav-users').classList.remove('hidden');
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            api.logout();
        });

        // Helper to format minutes to HH:MM:SS
        function formatDuration(minutes) {
            if (!minutes && minutes !== 0) return 'N/A';
            const totalSeconds = Math.round(minutes * 60);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
        }

        // Helper to format time remaining
        function formatTimeRemaining(prazoFim, prazoHoras, criadoEm) {
            if (!prazoFim) return '-';
            
            const agora = new Date();
            const prazo = new Date(prazoFim);
            
            // Se temos prazo_horas e criado_em, recalcular baseado nisso para evitar problemas de timezone
            if (prazoHoras && criadoEm) {
                const criado = new Date(criadoEm);
                const prazoCalculado = new Date(criado.getTime() + (prazoHoras * 60 * 60 * 1000));
                const diff = prazoCalculado - agora;
                
                if (diff <= 0) {
                    return '<span style="color: var(--danger);">Vencido</span>';
                }
                
                const horas = Math.floor(diff / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (horas < 1) {
                    return `<span style="color: var(--danger);">${minutos}m</span>`;
                } else if (horas < 3) {
                    return `<span style="color: var(--warning);">${horas}h ${minutos}m</span>`;
                } else {
                    return `${horas}h ${minutos}m`;
                }
            }
            
            // Fallback: usar prazo_fim diretamente
            const diff = prazo - agora;
            
            if (diff <= 0) {
                return '<span style="color: var(--danger);">Vencido</span>';
            }
            
            const horas = Math.floor(diff / (1000 * 60 * 60));
            const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (horas < 1) {
                return `<span style="color: var(--danger);">${minutos}m</span>`;
            } else if (horas < 3) {
                return `<span style="color: var(--warning);">${horas}h ${minutos}m</span>`;
            }
            
            return `${horas}h ${minutos}m`;
        }

        // Helper to format datetime
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            // Converter de UTC para timezone do Brasil (UTC-3)
            return date.toLocaleString('pt-BR', {
                timeZone: 'America/Sao_Paulo',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Helper to format porta placa (resumo no dashboard)
        function formatPortaPlaca(porta) {
            if (!porta) return '-';
            // Se tiver v√≠rgula, mostrar primeira porta + quantidade de outras
            const portas = porta.split(',').map(p => p.trim()).filter(p => p);
            if (portas.length > 1) {
                return `${portas[0]} +${portas.length - 1}`;
            }
            return porta;
        }

        // Helper to get status label
        function getStatusLabel(status) {
            const labels = {
                'aguardando': 'Aguardando',
                'em_andamento': 'Em Andamento',
                'concluido': 'Conclu√≠do'
            };
            return labels[status] || status;
        }

        // Helper to get tipo label
        function getTipoLabel(tipo) {
            const labels = {
                'rompimento': 'üîß Rompimento',
                'manutencao': '‚öôÔ∏è Manuten√ß√£o',
                'normal': 'üìã Normal'
            };
            return labels[tipo] || tipo;
        }

        // Load Rompimento/Manuten√ß√µes data
        async function loadRompimentoManutencao() {
            try {
                const osList = await api.getOrdensRompimentoManutencao();
                
                // Count stats
                let rompimentoAguardando = 0;
                let rompimentoAndamento = 0;
                let manutencaoAguardando = 0;
                let manutencaoAndamento = 0;
                
                osList.forEach(os => {
                    if (os.tipo_os === 'rompimento') {
                        if (os.status === 'aguardando') rompimentoAguardando++;
                        if (os.status === 'em_andamento') rompimentoAndamento++;
                    } else if (os.tipo_os === 'manutencao') {
                        if (os.status === 'aguardando') manutencaoAguardando++;
                        if (os.status === 'em_andamento') manutencaoAndamento++;
                    }
                });
                
                // Update stats
                document.getElementById('stat-rompimento-aguardando').textContent = rompimentoAguardando;
                document.getElementById('stat-rompimento-andamento').textContent = rompimentoAndamento;
                document.getElementById('stat-manutencao-aguardando').textContent = manutencaoAguardando;
                document.getElementById('stat-manutencao-andamento').textContent = manutencaoAndamento;
                
                // Update table
                const tbody = document.getElementById('rompimento-manutencao-tbody');
                if (osList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">Nenhuma O.S de Rompimento ou Manuten√ß√£o encontrada.</td></tr>';
                } else {
                    tbody.innerHTML = osList.map(os => `
                        <tr>
                            <td><strong>${os.numero_os}</strong></td>
                            <td>${getTipoLabel(os.tipo_os)}</td>
                            <td><span class="badge badge-${os.status}">${getStatusLabel(os.status)}</span></td>
                            <td>${os.cidade || '-'}</td>
                            <td>${os.prazo_horas ? os.prazo_horas + 'h' : '-'}</td>
                            <td>${formatTimeRemaining(os.prazo_fim, os.prazo_horas, os.criado_em)}</td>
                            <td>${formatPortaPlaca(os.porta_placa_olt)}</td>
                            <td>${os.tecnico_campo_nome || 'N/A'}</td>
                            <td>${os.tecnico_executor_nome || '-'}</td>
                            <td>${os.pppoe_cliente}</td>
                            <td>${formatDateTime(os.criado_em)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openOSDetails(${os.id})">Ver Detalhes</button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Update countdown every minute
                setInterval(() => {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        const os = osList[index];
                        if (os && os.prazo_fim) {
                            const timeCell = row.cells[5];
                            if (timeCell) {
                                timeCell.innerHTML = formatTimeRemaining(os.prazo_fim, os.prazo_horas, os.criado_em);
                            }
                        }
                    });
                }, 60000); // Update every minute
                
            } catch (error) {
                console.error('Error loading Rompimento/Manuten√ß√µes:', error);
                document.getElementById('rompimento-manutencao-tbody').innerHTML = 
                    '<tr><td colspan="12" class="text-center text-danger">Erro ao carregar dados.</td></tr>';
            }
        }

        // Helper to open OS details (same as os-list.html)
        function openOSDetails(osId) {
            window.location.href = `os-list.html?os_id=${osId}`;
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const data = await api.getDashboard();

                // Update stats
                document.getElementById('stat-aguardando').textContent = data.totais.aguardando;
                document.getElementById('stat-em-andamento').textContent = data.totais.em_andamento;
                document.getElementById('stat-concluido').textContent = data.totais.concluido;
                document.getElementById('stat-total').textContent = data.totais.total;
                document.getElementById('stat-sem-sinal').textContent = data.totais.motivo_sem_sinal || 0;
                document.getElementById('stat-ampliacao').textContent = data.totais.motivo_ampliacao || 0;
                document.getElementById('stat-sinal-alto').textContent = data.totais.motivo_sinal_alto || 0;

                // Update metrics
                document.getElementById('metric-espera').textContent = formatDuration(data.metricas.tempo_medio_espera_min);
                document.getElementById('metric-execucao').textContent = formatDuration(data.metricas.tempo_medio_execucao_min);
                document.getElementById('metric-total').textContent = formatDuration(data.metricas.tempo_medio_total_min);

                // Update technician stats
                const statsContainer = document.getElementById('tecnico-stats-container');

                if (data.por_tecnico.length === 0) {
                    statsContainer.innerHTML = '<p class="text-muted">Nenhum t√©cnico com servi√ßos conclu√≠dos ainda.</p>';
                } else {
                    statsContainer.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√©cnico</th>
                                        <th>Total Conclu√≠das</th>
                                        <th>Tempo M√©dio Execu√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.por_tecnico.map(t => `
                                        <tr>
                                            <td><strong>${t.tecnico_nome}</strong></td>
                                            <td>${t.total_concluidas}</td>
                                            <td>${t.tempo_medio_execucao_min ? Math.round(t.tempo_medio_execucao_min) + ' min' : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Update city stats
                const cityContainer = document.getElementById('cidade-stats-container');
                if (!data.por_cidade || data.por_cidade.length === 0) {
                    cityContainer.innerHTML = '<p class="text-muted">Nenhuma ordem com cidade registrada ainda.</p>';
                } else {
                    cityContainer.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cidade</th>
                                        <th>Total de O.S</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.por_cidade.map(c => `
                                        <tr>
                                            <td><strong>${c.cidade}</strong></td>
                                            <td>${c.total}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Show content, hide loading
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

                // Load Rompimento/Manuten√ß√µes data
                await loadRompimentoManutencao();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-error">
                        Erro ao carregar dashboard: ${error.message}
                    </div>
                `;
            }
        }

        // Load on page load
        loadDashboard();
    </script>
</body>

</html>