<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordens de Servi√ßo - Sistema O.S</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="navbar-brand">
                    üîß Sistema O.S
                </div>
                <div class="navbar-links">
                    <a href="dashboard.html" class="navbar-link">Dashboard</a>
                    <a href="os-list.html" class="navbar-link active">Ordens de Servi√ßo</a>
                    <span class="navbar-link" style="color: var(--text-primary);" id="user-name"></span>
                    <button class="btn btn-sm btn-secondary" id="logout-btn">Sair</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding: 2rem 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="margin: 0;">Ordens de Servi√ßo</h1>
            <button class="btn btn-primary" id="refresh-btn">üîÑ Atualizar</button>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <h3 class="mb-3">Filtros</h3>
            <div class="grid grid-3">
                <div class="form-group">
                    <label for="filter-status">Status</label>
                    <select id="filter-status">
                        <option value="">Todos</option>
                        <option value="aguardando">Aguardando</option>
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluido">Conclu√≠do</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" id="apply-filters-btn" style="width: 100%;">Aplicar Filtros</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <div id="os-list-container" class="hidden">
            <!-- OS list will be inserted here -->
        </div>

        <div id="empty-state" class="hidden card text-center">
            <h3 class="text-muted">Nenhuma O.S encontrada</h3>
            <p class="text-muted">Tente ajustar os filtros ou aguarde novas ordens de servi√ßo.</p>
        </div>
    </div>

    <!-- Modal for OS Details -->
    <div id="os-modal" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div class="container" style="padding: 2rem 1rem;">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;" id="modal-title">Detalhes da O.S</h2>
                    <button class="btn btn-secondary" id="close-modal-btn">‚úï Fechar</button>
                </div>

                <div id="modal-content">
                    <!-- Content will be inserted here -->
                </div>

                <div id="modal-actions" class="mt-3" style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <!-- Action buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Auth guard
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        const user = api.getUser();
        document.getElementById('user-name').textContent = user.nome || user.username;

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            api.logout();
        });

        let currentOSList = [];

        // Load OS list
        async function loadOSList() {
            const statusFilter = document.getElementById('filter-status').value;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('os-list-container').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            try {
                const filters = {};
                if (statusFilter) filters.status = statusFilter;

                const osList = await api.getOrdensList(filters);
                currentOSList = osList;

                if (osList.length === 0) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }

                renderOSList(osList);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('os-list-container').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading OS list:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-error">
                        Erro ao carregar lista: ${error.message}
                    </div>
                `;
            }
        }

        function renderOSList(osList) {
            const container = document.getElementById('os-list-container');

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N√∫mero O.S</th>
                                <th>Status</th>
                                <th>T√©cnico Campo</th>
                                <th>T√©cnico Executor</th>
                                <th>PPPOE</th>
                                <th>Criado Em</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${osList.map(os => `
                                <tr>
                                    <td><strong>${os.numero_os}</strong></td>
                                    <td><span class="badge badge-${os.status}">${getStatusLabel(os.status)}</span></td>
                                    <td>${os.tecnico_campo_nome || 'N/A'}</td>
                                    <td>${os.tecnico_executor_nome || '-'}</td>
                                    <td>${os.pppoe_cliente}</td>
                                    <td>${formatDateTime(os.criado_em)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="openOSDetails(${os.id})">Ver Detalhes</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function openOSDetails(osId) {
            try {
                const os = await api.getOrdemById(osId);

                document.getElementById('modal-title').textContent = `O.S ${os.numero_os}`;

                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <div class="grid grid-2 mb-3">
                        <div>
                            <strong>Status:</strong><br>
                            <span class="badge badge-${os.status}">${getStatusLabel(os.status)}</span>
                        </div>
                        <div>
                            <strong>PPPOE:</strong><br>
                            ${os.pppoe_cliente}
                        </div>
                    </div>

                    <div class="grid grid-2 mb-3">
                        <div>
                            <strong>T√©cnico de Campo:</strong><br>
                            ${os.tecnico_campo.nome || os.tecnico_campo.username}
                        </div>
                        <div>
                            <strong>T√©cnico Executor:</strong><br>
                            ${os.tecnico_executor ? (os.tecnico_executor.nome || os.tecnico_executor.username) : '-'}
                        </div>
                    </div>

                    <div class="grid grid-2 mb-3">
                        <div>
                            <strong>Motivo Abertura:</strong><br>
                            <span class="badge badge-info">${os.motivo_abertura || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Telegram Solicitante:</strong><br>
                            ${os.telegram_nick || 'N/A'} ${os.telegram_phone ? `(${os.telegram_phone})` : ''}
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Localiza√ß√£o:</strong><br>
                        ${os.localizacao_lat && os.localizacao_lng
                        ? `<a href="https://www.google.com/maps?q=${os.localizacao_lat},${os.localizacao_lng}" target="_blank" class="btn btn-sm btn-secondary mt-1">üìç Ver no Google Maps</a>`
                        : 'N/A'}
                        ${os.localizacao_precisao ? `<br><small class="text-muted">Precis√£o: ${os.localizacao_precisao}m</small>` : ''}
                    </div>

                    <div class="mb-3">
                        <strong>Fotos:</strong><br>
                        <div class="grid grid-2 mt-1">
                            <a href="${os.foto_power_meter}" target="_blank" class="btn btn-sm btn-secondary">üñºÔ∏è Power Meter</a>
                            <a href="${os.foto_caixa}" target="_blank" class="btn btn-sm btn-secondary">üñºÔ∏è Caixa</a>
                            <a href="${os.print_os_cliente}" target="_blank" class="btn btn-sm btn-secondary">üñºÔ∏è Print O.S</a>
                            ${os.foto_comprovacao ? `<a href="${os.foto_comprovacao}" target="_blank" class="btn btn-sm btn-secondary">üñºÔ∏è Comprova√ß√£o</a>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-3 mb-3">
                        <div>
                            <strong>Criado:</strong><br>
                            ${formatDateTime(os.criado_em)}
                        </div>
                        <div>
                            <strong>Iniciado:</strong><br>
                            ${os.iniciado_em ? formatDateTime(os.iniciado_em) : '-'}
                        </div>
                        <div>
                            <strong>Conclu√≠do:</strong><br>
                            ${os.concluido_em ? formatDateTime(os.concluido_em) : '-'}
                        </div>
                    </div>

                    ${os.tempo_espera_min || os.tempo_execucao_min || os.tempo_total_min ? `
                        <div class="grid grid-3 mb-3">
                            ${os.tempo_espera_min ? `<div><strong>Tempo Espera:</strong><br>${Math.round(os.tempo_espera_min)} min</div>` : ''}
                            ${os.tempo_execucao_min ? `<div><strong>Tempo Execu√ß√£o:</strong><br>${Math.round(os.tempo_execucao_min)} min</div>` : ''}
                            ${os.tempo_total_min ? `<div><strong>Tempo Total:</strong><br>${Math.round(os.tempo_total_min)} min</div>` : ''}
                        </div>
                    ` : ''}

                    ${os.observacoes ? `
                        <div class="mb-3">
                            <strong>Observa√ß√µes:</strong><br>
                            <p>${os.observacoes}</p>
                        </div>
                    ` : ''}
                `;

                // Action buttons based on role and status
                const modalActions = document.getElementById('modal-actions');
                modalActions.innerHTML = '';

                // Execu√ß√£o can assume if aguardando
                if ((user.role === 'execucao' || user.role === 'admin') && os.status === 'aguardando') {
                    modalActions.innerHTML += `
                        <button class="btn btn-success" onclick="assumirOS(${os.id})">‚úì Assumir O.S</button>
                    `;
                }

                // Execu√ß√£o can finalize their own OS
                if ((user.role === 'execucao' || user.role === 'admin') && os.status === 'em_andamento' &&
                    (user.role === 'admin' || os.tecnico_executor?.id === user.id)) {
                    modalActions.innerHTML += `
                        <button class="btn btn-success" onclick="showFinalizarForm(${os.id})">‚úì Finalizar O.S</button>
                    `;
                }

                // Admin can delete
                if (user.role === 'admin') {
                    modalActions.innerHTML += `
                        <button class="btn btn-danger" onclick="deleteOS(${os.id})">üóëÔ∏è Excluir</button>
                    `;
                }

                document.getElementById('os-modal').classList.remove('hidden');

            } catch (error) {
                alert(`Erro ao carregar detalhes: ${error.message}`);
            }
        }

        async function assumirOS(osId) {
            if (!confirm('Deseja assumir esta O.S?')) return;

            try {
                await api.assumirOrdem(osId, user.id);
                alert('O.S assumida com sucesso!');
                closeModal();
                loadOSList();
            } catch (error) {
                alert(`Erro ao assumir O.S: ${error.message}`);
            }
        }

        function showFinalizarForm(osId) {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="alert alert-info mb-3">
                    <strong>üì∏ Finalizar O.S</strong><br>
                    Envie a foto de comprova√ß√£o da conclus√£o do servi√ßo.
                </div>
                
                <form id="finalizar-form">
                    <div class="form-group">
                        <label for="foto-comprovacao">Foto de Comprova√ß√£o *</label>
                        <input type="file" id="foto-comprovacao" accept="image/*" capture="environment" required 
                            style="padding: 0.5rem; background: var(--bg-tertiary); border: 2px dashed var(--border); border-radius: var(--radius-md);">
                        <small class="text-muted">Tire uma foto ou selecione do dispositivo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes-finalizacao">Observa√ß√µes (opcional)</label>
                        <textarea id="observacoes-finalizacao" rows="4" placeholder="Descreva o trabalho realizado..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="openOSDetails(${osId})">Cancelar</button>
                        <button type="submit" class="btn btn-success">‚úì Finalizar O.S</button>
                    </div>
                </form>
            `;

            document.getElementById('finalizar-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const fileInput = document.getElementById('foto-comprovacao');
                const observacoes = document.getElementById('observacoes-finalizacao').value;

                if (!fileInput.files || !fileInput.files[0]) {
                    alert('Por favor, selecione uma foto de comprova√ß√£o');
                    return;
                }

                await finalizarOS(osId, fileInput.files[0], observacoes);
            });

            // Hide action buttons while showing form
            document.getElementById('modal-actions').innerHTML = '';
        }

        async function finalizarOS(osId, fotoFile, observacoes) {
            try {
                // Show loading state
                const submitBtn = document.querySelector('#finalizar-form button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Enviando...';

                await api.finalizarOrdemComFoto(osId, fotoFile, observacoes);
                alert('O.S finalizada com sucesso!');
                closeModal();
                loadOSList();
            } catch (error) {
                alert(`Erro ao finalizar O.S: ${error.message}`);
                // Restore button
                const submitBtn = document.querySelector('#finalizar-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úì Finalizar O.S';
                }
            }
        }

        async function deleteOS(osId) {
            if (!confirm('Tem certeza que deseja EXCLUIR esta O.S? Esta a√ß√£o n√£o pode ser desfeita.')) return;

            try {
                await api.deleteOrdem(osId);
                alert('O.S exclu√≠da com sucesso!');
                closeModal();
                loadOSList();
            } catch (error) {
                alert(`Erro ao excluir O.S: ${error.message}`);
            }
        }

        function closeModal() {
            document.getElementById('os-modal').classList.add('hidden');
        }

        function getStatusLabel(status) {
            const labels = {
                'aguardando': 'Aguardando',
                'em_andamento': 'Em Andamento',
                'concluido': 'Conclu√≠do'
            };
            return labels[status] || status;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', loadOSList);
        document.getElementById('apply-filters-btn').addEventListener('click', loadOSList);
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);

        // Load on page load
        loadOSList();
    </script>
</body>

</html>